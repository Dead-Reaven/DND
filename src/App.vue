<script>

export default {
	data() {
		return {
			teamsWithUsers: [
				{
					"id": 1660, "class_id": 2986, "const": "1", "name": "Ð›Ð•Ð’Ð˜", "hash": "NWdWwwyWj3e57bun", "training_hits": 45, "training_score": 2, "created_at": "2023-11-14T07:11:45.000000Z", "updated_at": "2024-09-18T11:29:08.000000Z", "score": 62, "total_score": 64, "users": [{ "id": 17363, "name": "Ð‘Ñ–Ð»Ð°Ð½ ÐÐ½Ð³ÐµÐ»Ñ–Ð½Ð° ÐŸÐ°Ð²Ð»Ñ–Ð²Ð½Ð°", "pivot": { "team_id": 1660, "user_id": 17363, "gist": "captain" } },
					{ "id": 17364, "name": "Ð‘Ñ–Ð»Ð°Ð½ Ð›Ñ–Ð»Ñ–Ñ Ð’Ð°ÑÐ¸Ð»Ñ–Ð²Ð½Ð°", "pivot": { "team_id": 1660, "user_id": 17364, "gist": null } }, { "id": 17368, "name": "Ð›ÐµÐ²Ð¸Ñ†ÑŒÐºÐ° Ð’Ð°Ð»ÐµÑ€Ñ–Ñ ÐÐ½Ð´Ñ€Ñ–Ñ—Ð²Ð½Ð°", "pivot": { "team_id": 1660, "user_id": 17368, "gist": null } }, { "id": 17370, "name": "ÐœÐ°ÐºÑÐ¸Ð¼Ñ–Ð² ÐœÐ°ÐºÑÐ¸Ð¼", "pivot": { "team_id": 1660, "user_id": 17370, "gist": null } }, { "id": 17719, "name": "ÐœÐ°Ñ…Ð°Ð½Ñ‡ÑƒÐº Ð†Ð½Ð½Ð°", "pivot": { "team_id": 1660, "user_id": 17719, "gist": null } }, { "id": 21044, "name": "ÐšÐ°Ñ‡Ð°Ð»Ð° ÐžÐºÑÐ°Ð½Ð°", "pivot": { "team_id": 1660, "user_id": 21044, "gist": null } }, { "id": 20639, "name": "ÐœÐ°Ð³Ð´Ð° Ð¢ÐµÑ‚ÑÐ½Ð°", "pivot": { "team_id": 1660, "user_id": 20639, "gist": null } }, { "id": 17379, "name": "Ð§ÐµÐ¿Ñ–Ð»ÑŒ Ð Ð¾Ð¼Ð°Ð½ ÐžÐ¼ÐµÐ»ÑÐ½Ð¾Ð²Ð¸Ñ‡", "pivot": { "team_id": 1660, "user_id": 17379, "gist": null } }]
				},
				{
					"id": 1661, "class_id": 2986, "const": "2", "name": "Ð¤Ð£Ð¢Ð‘ÐžÐ›", "hash": "GG1nDo48s801b45h", "training_hits": 51, "training_score": 2, "created_at": "2023-11-14T07:11:45.000000Z", "updated_at": "2024-10-03T09:01:15.000000Z", "score": 36, "total_score": 38, "users": [{ "id": 17217, "name": "Ð“Ð½Ð°Ñ‚Ð¸ÑˆÐ¸Ð½ Ð’Ð¾Ð»Ð¾Ð´Ð¸Ð¼Ð¸Ñ€ ÐœÐ¸Ñ…Ð°Ð¹Ð»Ð¾Ð²Ð¸Ñ‡", "pivot": { "team_id": 1661, "user_id": 17217, "gist": null } },
					{ "id": 17341, "name": "ÐšÑ–Ð½Ð¸Ðº Ð¡Ð¾Ñ„Ñ–Ñ ÐŸÐ°Ð²Ð»Ñ–Ð²Ð½Ð°", "pivot": { "team_id": 1661, "user_id": 17341, "gist": null } }, { "id": 17365, "name": "ÐšÐ¼ÐµÑ‚ÑŒ ÐžÐ»ÐµÐ³ Ð Ð¾Ð¼Ð°Ð½Ð¾Ð²Ð¸Ñ‡", "pivot": { "team_id": 1661, "user_id": 17365, "gist": null } }, { "id": 17366, "name": "Ð“Ð¾Ñ”Ð² Ð’Ð°ÑÐ¸Ð»ÑŒ Ð’Ð°ÑÐ¸Ð»ÑŒÐ¾Ð²Ð¸Ñ‡", "pivot": { "team_id": 1661, "user_id": 17366, "gist": "captain" } }, { "id": 17371, "name": "ÐŸÐ¾Ð´Ñ–Ð±ÐºÐ° ÐœÐ°Ñ€'ÑÐ½Ð° ÐžÐ»ÐµÐ³Ñ–Ð²Ð½Ð°", "pivot": { "team_id": 1661, "user_id": 17371, "gist": null } }, { "id": 17767, "name": "ÐšÐ¾Ð¿Ñ‚ÐµÐ²Ð° ÐÐ°Ð´Ñ–Ñ", "pivot": { "team_id": 1661, "user_id": 17767, "gist": null } }, { "id": 17372, "name": "ÐŸÑ€ÑƒÑ ÐÐ°Ð·Ð°Ñ€Ñ–Ð¹ Ð’Ð°ÑÐ¸Ð»ÑŒÐ¾Ð²Ð¸Ñ‡", "pivot": { "team_id": 1661, "user_id": 17372, "gist": null } }, { "id": 17373, "name": "Ð ÑƒÐ´ÐºÐ° Ð¡Ð¾Ñ„Ñ–Ñ ÐÐ½Ð´Ñ€Ñ–Ñ—Ð²Ð½Ð°", "pivot": { "team_id": 1661, "user_id": 17373, "gist": null } }, { "id": 20283, "name": "Ð ÑƒÑÐ½ÑÐº ÐžÐ»ÐµÑÑ", "pivot": { "team_id": 1661, "user_id": 20283, "gist": null } }, { "id": 17374, "name": "Ð ÑƒÑ‡Ð¸Ð½ÑÑŒÐºÐ¸Ð¹ ÐÐ°Ð·Ð°Ñ€Ñ–Ð¹ Ð’Ð°ÑÐ¸Ð»ÑŒÐ¾Ð²Ð¸Ñ‡", "pivot": { "team_id": 1661, "user_id": 17374, "gist": null } }, { "id": 19677, "name": "Ð¥Ñ€ÑƒÑ‰ÐµÐ² Ð®Ñ€Ñ–Ð¹", "pivot": { "team_id": 1661, "user_id": 19677, "gist": null } }, { "id": 17380, "name": "Ð§Ð¾Ð²Ð³Ð°Ð½ ÐšÑ–Ñ€Ð° Ð ÑƒÑÐ»Ð°Ð½Ñ–Ð²Ð½Ð°", "pivot": { "team_id": 1661, "user_id": 17380, "gist": null } }]
				},
				{ "id": 1662, "class_id": 2986, "const": "3", "name": "Ð§Ð„Ð›Ð†ÐšÐ˜", "hash": "7nPM6JVMW8CP6Pvx", "training_hits": 47, "training_score": 5, "created_at": "2023-11-14T07:11:45.000000Z", "updated_at": "2024-09-23T09:26:35.000000Z", "score": 106, "total_score": 111, "users": [{ "id": 10102, "name": "ÐšÐ¸Ñ„Ð¾Ñ€ Ð¯Ð½Ð° Ð†Ð³Ð¾Ñ€Ñ–Ð²Ð½Ð°", "pivot": { "team_id": 1662, "user_id": 10102, "gist": "captain" } }, { "id": 18427, "name": "Ð“Ð¾Ð½Ñ‡Ð°Ñ€Ð¾Ð²Ð° Ð¢ÐµÑ‚ÑÐ½Ð°", "pivot": { "team_id": 1662, "user_id": 18427, "gist": null } }, { "id": 18626, "name": "Ð“Ð¾Ð½Ñ†Ð¾Ð²ÑÑŒÐºÐ° ÐžÐ»ÐµÐ½Ð°", "pivot": { "team_id": 1662, "user_id": 18626, "gist": null } }, { "id": 17375, "name": "Ð¢Ð¸Ñ‡ÐºÐ¾Ð² ÐœÐ°ÐºÑÐ¸Ð¼ Ð’Ð°ÑÐ¸Ð»ÑŒÐ¾Ð²Ð¸Ñ‡", "pivot": { "team_id": 1662, "user_id": 17375, "gist": null } }, { "id": 17376, "name": "Ð¢ÐºÐ°Ñ‡ÑƒÐº Ð¯Ð½Ð° Ð’Ð°ÑÐ¸Ð»Ñ–Ð²Ð½Ð°", "pivot": { "team_id": 1662, "user_id": 17376, "gist": null } }, { "id": 17377, "name": "Ð¢Ñ€Ð¾ÑÑ‚ÑÐ½Ñ‡Ð¸Ð½ Ð”Ñ–Ð°Ð½Ð° ÐÐ½Ð´Ñ€Ñ–Ñ—Ð²Ð½Ð°", "pivot": { "team_id": 1662, "user_id": 17377, "gist": null } }, { "id": 17378, "name": "Ð¢ÑƒÑ€Ñ‡Ð¸Ð½ ÐœÐ°Ñ‚Ð²Ñ–Ð¹ ÐÐ½Ð´Ñ€Ñ–Ð¹Ð¾Ð²Ð¸Ñ‡", "pivot": { "team_id": 1662, "user_id": 17378, "gist": null } }, { "id": 17381, "name": "Ð¯Ñ€ÐµÐ¼ÐºÐ¾ ÐžÐ»ÐµÐ³ ÐÐ½Ð´Ñ€Ñ–Ð¹Ð¾Ð²Ð¸Ñ‡", "pivot": { "team_id": 1662, "user_id": 17381, "gist": null } }] }]
			,
			games: {
				"1660": { "replies_count": 10, "training_score": 10, "score": 20, "total_score": 30, "isWin": true },
				"1661": { "replies_count": 0, "training_score": 0, "score": 0, "total_score": 0, "isWin": false },
				"1662": { "replies_count": 0, "training_score": 0, "score": 0, "total_score": 0, "isWin": false }
			},
			trainingHits: { "9978": 3 }
		}
	},

	methods: {
		onChangeCaptain(team, user) {
			// Uncomment when ready to integrate with backend
			// this.axios.post(`teacher/teams/${team.id}/captain/${user.id}`).then(resp => {
			// 	if (confirm('ÐŸÐ¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ñ‚Ð¸ Ð´Ð°Ð½Ñ–.')) {
			// 		location.reload();
			// 	}
			// });
		},

		isCaptain(team, user) {
			return user?.pivot.gist === 'captain';
		},

		// Initiate dragging; add a flag for both desktop & mobile
		onDragStart(event, user) {
			this.draggedUserID = user.id;
			if (event.dataTransfer) {
				event.dataTransfer.dropEffect = 'move';
				event.dataTransfer.effectAllowed = 'move';
				event.dataTransfer.setData('userID', user.id.toString());
			}
		},

		// Handle drop logic for both desktop and mobile
		onDrop(event, teamID, index) {
			const userID = this.draggedUserID || parseInt(event.dataTransfer?.getData('userID'));
			if (!userID) return;

			let targetUser;

			this.teamsWithUsers = this.teamsWithUsers.map(team => {
				const newUsers = team.users.filter(user => {
					if (user.id === userID && !user.pivot.gist && user.pivot.team_id !== teamID) {
						user.pivot.team_id = teamID;
						targetUser = user; // Store user for later
						return false; // Exclude the dragged user from current team
					}
					return true;
				});
				return { ...team, users: newUsers };
			});

			if (targetUser) this.teamsWithUsers[index].users.push(targetUser);

			this.draggedUserID = null; // Reset dragged user ID
		},
	},
};


</script>

<template>
	<div class="teams-wrap">
		<div class="teams">
			<template v-for="(team, index) in teamsWithUsers" :key="team.id">
				<div v-if="team.users.length" class="team" @dragover.prevent @dragenter.prevent
					@drop="onDrop($event, team.id, index)">
					<h3 contenteditable @keydown.enter.prevent="$event.target.blur()"
						@focusout="($event.target.textContent !== team.name) && onChangeTeamName(team, $event.target.textContent)"
						spellcheck="false" title="ÐŸÑ€Ð¸Ð´ÑƒÐ¼Ð°Ð¹Ñ‚Ðµ ÑƒÐ½Ñ–ÐºÐ°Ð»ÑŒÐ½Ñƒ Ð½Ð°Ð·Ð²Ñƒ Ð´Ð»Ñ Ñ†Ñ–Ñ”Ñ— ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¸">
						{{ team.name }}
					</h3>
					<hr />
					<section class="scores">
						<div>
							<small class="remark">Ð‘Ð°Ð»Ð¸ Ð·Ð° Ð¿Ñ–Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÑƒ</small>
							<div class="score" title="Ð‘Ð°Ð»Ð¸ Ð·Ð° Ð¿Ñ–Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÑƒ (ÑÐµÑ€ÐµÐ´Ð½Ñ” Ð°Ñ€Ð¸Ñ„Ð¼ÐµÑ‚Ð¸Ñ‡Ð½Ðµ)">
								{{ games[team.id]?.training_score || 0 }}
							</div>
						</div>

						<div class="score" style="font-size: 40px; cursor: pointer" @click="recalculateTeamScore(team)"
							title="Ð—Ð°Ð³Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ð±Ð°Ð». ÐÐ°Ñ‚Ð¸ÑÐ½Ñ–Ñ‚ÑŒ Ñ‰Ð¾Ð± Ð¿ÐµÑ€ÐµÑ€Ð°Ñ…ÑƒÐ²Ð°Ñ‚Ð¸">
							<!-- @todo Ð’Ð¸Ð²ÐµÑÑ‚Ð¸ ÑÑƒÐ¼Ð°Ñ€Ð½Ð¸Ð¹ Ð±Ð°Ð» -->
							{{ games[team.id]?.total_score || 0 }}
						</div>
						<!--<div class="recalculate-button" title="ÐŸÐµÑ€ÐµÑ€Ð°Ñ…ÑƒÐ²Ð°Ñ‚Ð¸ Ð±Ð°Ð»Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¸" @click="recalculateTeamScore(team)">
								ðŸ§®
							</div>-->
						<div>
							<small class="remark">Ð‘Ð°Ð»Ð¸ Ð·Ð° Ð³Ñ€Ñƒ</small>
							<div class="score" title="Ð‘Ð°Ð»Ð¸ Ð·Ð° Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ– Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ– Ñƒ Ð³Ñ€Ñ–">
								{{ games[team.id]?.score || 0 }}
							</div>
						</div>
					</section>
					<hr />

					<div class="participants">
						<div v-for="(user, key) in team.users" :key="user.id" @dragstart="onDragStart($event, user)"
							:draggable="!user.pivot.gist">
							<input type="radio" :name="`captain_${team.id}`" class="captain"
								@change="onChangeCaptain(team, user)" :checked="isCaptain(team, user)"
								:title="isCaptain(team, user) ? 'ÐšÐ°Ð¿Ñ–Ñ‚Ð°Ð½ Ð´Ð¾Ð¼Ð°Ð½Ð´Ð¸' : 'ÐÐ°Ð·Ð½Ð°Ñ‡Ð¸Ñ‚Ð¸ ÐºÐ°Ð¿Ñ–Ñ‚Ð°Ð½Ð¾Ð¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¸'" />
							{{ user.name }}
							<!-- <span v-if="trainingHits[user.id]" title="ÐŸÐµÑ€ÐµÐ³Ð»ÑÐ½ÑƒÑ‚Ð¾ Ð¿Ñ–Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ñ‡Ð¸Ñ… Ð¼Ð°Ñ‚ÐµÑ€Ñ–Ð°Ð»Ñ–Ð²">
							<sup style="color: var(--orange)">â˜…{{ trainingHits[user.id] }}</sup>
						</span> -->
						</div>
					</div>
					<div class="qr" :data-team-hash="team.hash"
						@click.exact="$store.copyText($event.target.closest('div')?.getAttribute('data-qr-url'))"
						@click.ctrl="$store.open($event.target.closest('div')?.getAttribute('data-qr-url'))">
						<!-- QR -->
					</div>
					<!-- <img src="@/assets/img/team-children.png" alt="ÐšÐ¾Ð¼Ð°Ð½Ð´Ð°" class="children" /> -->
				</div>
			</template>

		</div>
	</div>


</template>

<style lang="scss" scoped>
.teams {
	display: flex;
	justify-content: center;
	gap: 10px;
	flex-wrap: wrap;
}

.team {
	width: 32%;
	padding: 20px;
	border: 3px solid;
	border-radius: 16px;
	display: flex;
	flex-direction: column;
	min-width: min(320px, 90dvw);
	overflow: hidden;

	& [draggable="true"] {
		transition: all 0.3s ease;
		cursor: grab;

		&:hover {
			background: rgba(255, 255, 255, 0.299);
		}
	}

	h3 {
		text-align: center;
		font-size: 26px;
		color: #e72667;
		margin: 0;
		line-height: 1;
		min-height: 52px;
		display: flex;
		justify-content: center;
		align-items: center;
	}

	.scores {
		display: flex;
		justify-content: space-around;
		align-items: center;
		gap: 3px;

		.remark {
			font-size: 12px;
			max-width: 63px;
			text-align: center;
			color: #b8b1ee;
			display: block;
		}

		.score {
			text-align: center;
			font-weight: bold;
			color: var(--orange);
		}
	}

	hr {
		margin: 15px 20px;
		border-top: 2px solid #e72667;
	}

	.recalculate-button {
		cursor: pointer;
		transition: all .3s linear;
	}

	.recalculate-button:hover {
		transform: scale(1.2);
	}

	.qr {
		display: flex;
		justify-content: center;
		margin-top: 20px;
		cursor: none !important;
	}

	.qr:not(:hover) {
		filter: blur(10px);
		opacity: 0.2;
	}

	.participants {
		flex-grow: 1;
		text-align: left;
	}

	.participants>*:not(:last-child) {
		margin-bottom: 10px;
	}

	.captain {
		margin-right: 8px;
		vertical-align: middle;
		cursor: pointer;
	}

	/*.captain:not(:checked) {visibility: hidden;}*/

	img.children {
		transform: translate(20px, 20px);
		opacity: 0.9;
	}
}













.team:nth-child(1) {
	border-color: #e72667;

	hr {
		border-color: #e72667;
	}

	h3,
	.score {
		color: #e72667
	}
}

.team:nth-child(2) {
	border-color: #FF8A00;

	hr {
		border-color: #FF8A00;
	}

	h3,
	.score {
		color: #FF8A00
	}
}

.team:nth-child(3) {
	border-color: #8dc645;

	hr {
		border-color: #8dc645;
	}

	h3,
	.score {
		color: #8dc645
	}
}
</style>
